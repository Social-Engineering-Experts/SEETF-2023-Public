FROM python:3.11-slim AS build

# Install wget, unzip
# Install FLOSS
WORKDIR /tmp
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
	wget \
    unzip \
	&& rm -rf /var/lib/apt/lists/*
RUN wget https://github.com/mandiant/flare-floss/releases/download/v2.2.0/floss-v2.2.0-linux.zip -O floss.zip \
    && unzip floss.zip \
    && rm floss.zip
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt

FROM python:3.11-slim AS deploy
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    unzip \
	&& rm -rf /var/lib/apt/lists/*
COPY --from=build /tmp/floss /usr/local/bin/floss
COPY --from=build /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY flag.txt /etc/flag
COPY app/ /app/
ENTRYPOINT ["python", "-m", "uvicorn", "app:app", "--host", "0.0.0.0"]
